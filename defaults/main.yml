---
# defaults file for traefik

# file/directory variabls
traefik_source_base_path: "/etc/traefik"
traefik_source_acme_path: "{{ traefik_source_base_path }}/acme.json"

# configuration variables
traefik_checknewversion: "false"
traefik_sendanonymoususage: "false"
traefik_dashboard_enabled: "false"
traefik_log_level: "ERROR"
traefik_pilot_dashboard: "false"
traefik_docker_provider:
  watch: "true"
  network: "{{ traefik_service_name }}"
  exposedByDefault: "false"
  endpoint: "unix:///var/run/docker.sock"

# container variables
traefik_service_name: "traefik"
traefik_image: "{{ traefik_image_name }}:{{ traefik_image_tag }}"
traefik_image_name: "traefik"
traefik_image_tag: "3.6.5"
# ACME challenge configuration
# Certificate resolver name (referenced in entrypoints and labels)
traefik_certresolver_name: "live"

# Challenge type: "http" or "dns"
traefik_acme_challenge_type: "http"

# DNS challenge provider (e.g., cloudflare, route53, digitalocean, ovh)
# See https://go-acme.github.io/lego/dns/ for full list
traefik_acme_dns_provider: ""

# DNS challenge environment variables
# These are provider-specific credentials required for DNS challenge
# Example for Cloudflare:
#   CF_API_EMAIL: your@email.com
#   CF_DNS_API_TOKEN: your_api_token
# Example for DigitalOcean:
#   DO_AUTH_TOKEN: your_auth_token
traefik_acme_dns_env: {}

# Custom DNS resolvers for DNS challenge validation
# Empty list uses provider defaults
# Example: ["1.1.1.1:53", "8.8.8.8:53"]
traefik_acme_dns_resolvers: []

# ACME email for Let's Encrypt notifications
traefik_acme_email: ""

# Delay before DNS record verification (in seconds)
traefik_acme_dns_delay_before_check: 0

traefik_cli_base:
  - "--global.checknewversion={{ traefik_checknewversion }}"
  - "--global.sendanonymoususage={{ traefik_sendanonymoususage }}"
  - "--api.dashboard={{ traefik_dashboard_enabled }}"
  - "--log.level={{ traefik_log_level }}"
  - "--providers.docker.watch={{ traefik_docker_provider.watch }}"
  - "--providers.docker.network={{ traefik_docker_provider.network }}"
  - "--providers.docker.exposedByDefault={{ traefik_docker_provider.exposedByDefault }}"
  - "--providers.docker.endpoint={{ traefik_docker_provider.endpoint }}"
  - "--entrypoints.web.address=:80"
  - "--entrypoints.web.http.redirections.entrypoint.to=:443"
  - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
  - "--entrypoints.web_secure.address=:443"
  - "--entrypoints.web_secure.http.tls=true"
  - "--entrypoints.web_secure.http.tls.certresolver={{ traefik_certresolver_name }}"
  - "--certificatesresolvers.{{ traefik_certresolver_name }}=true"

# HTTP challenge configuration (default)
traefik_cli_http_challenge:
  - "--certificatesresolvers.{{ traefik_certresolver_name }}.acme.httpchallenge=true"
  - >-
    --certificatesresolvers.{{ traefik_certresolver_name }}.acme.httpchallenge.entrypoint=web

# DNS challenge configuration
traefik_cli_dns_challenge_base:
  - "--certificatesresolvers.{{ traefik_certresolver_name }}.acme.dnschallenge=true"
  - >-
    --certificatesresolvers.{{ traefik_certresolver_name }}.acme.dnschallenge.provider={{
    traefik_acme_dns_provider }}
  - >-
    --certificatesresolvers.{{ traefik_certresolver_name }}.acme.dnschallenge.delaybeforecheck={{
    traefik_acme_dns_delay_before_check }}

# DNS challenge custom resolvers (optional)
traefik_cli_dns_challenge_resolvers: >-
  {{
    ['--certificatesresolvers.' + traefik_certresolver_name +
    '.acme.dnschallenge.resolvers=' + (traefik_acme_dns_resolvers | join(','))]
    if traefik_acme_dns_resolvers | length > 0 else []
  }}

# Combined DNS challenge configuration
traefik_cli_dns_challenge: "{{
  traefik_cli_dns_challenge_base + traefik_cli_dns_challenge_resolvers
  }}"

# Email configuration for ACME (optional but recommended)
traefik_cli_acme_email: >-
  {{
    ['--certificatesresolvers.' + traefik_certresolver_name + '.acme.email=' + traefik_acme_email]
    if traefik_acme_email else []
  }}

# Select challenge type based on configuration
traefik_cli_challenge: "{{
  traefik_cli_dns_challenge if traefik_acme_challenge_type == 'dns'
  else traefik_cli_http_challenge
  }}"

# https://doc.traefik.io/traefik/reference/static-configuration/cli/
traefik_cli_commands_extension: []
traefik_custom_cli_commands: []
traefik_cli_commands: "{{
  traefik_cli_base + traefik_cli_challenge + traefik_cli_acme_email + traefik_cli_commands_extension
  if traefik_custom_cli_commands | length == 0 else traefik_custom_cli_commands
  }}"

traefik_networks:
  - name: "{{ traefik_service_name }}"

traefik_ports:
  - "80:80"
  - "443:443"

traefik_api_rule: "Host(`traefik.{{ inventory_hostname }}`)"
traefik_labels:
  traefik.enable: "true"
  traefik.http.routers.traefik_api.rule: "{{ traefik_api_rule }}"
  traefik.http.routers.traefik_api.entrypoints: "web_secure"
  traefik.http.routers.traefik_api.service: "api@internal"
  traefik.http.routers.traefik_api.tls.certresolver: "{{ traefik_certresolver_name }}"

traefik_mounts:
  - source: /var/run/docker.sock
    target: /var/run/docker.sock
    type: bind
    read_only: true
  - source: "{{ traefik_source_acme_path }}"
    target: /acme.json
    type: bind
